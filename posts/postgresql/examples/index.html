<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Some Postgresql Examples</title>
<meta name=description content="Examples that can paint a clearer picture about some powerful features and patterns of PG-SQL"><meta name=keywords content='blog,datDhruv,datdhruv,typdef,postgresql'><meta property="og:url" content="http://typdef.com/posts/postgresql/examples/"><meta property="og:type" content="website"><meta property="og:title" content="Some Postgresql Examples"><meta property="og:description" content="Examples that can paint a clearer picture about some powerful features and patterns of PG-SQL"><meta property="og:image" content="http://typdef.com/"><meta property="og:image:secure_url" content="http://typdef.com/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Some Postgresql Examples"><meta name=twitter:description content="Examples that can paint a clearer picture about some powerful features and patterns of PG-SQL"><meta property="twitter:domain" content="http://typdef.com/posts/postgresql/examples/"><meta property="twitter:url" content="http://typdef.com/posts/postgresql/examples/"><meta name=twitter:image content="http://typdef.com/"><link rel=canonical href=http://typdef.com/posts/postgresql/examples/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.224c8e70fed292d18d7d9ae1b36797c99144e0be1117e2ea2c428379c8496551.js integrity="sha256-IkyOcP7SktGNfZrhs2eXyZFE4L4RF+LqLEKDechJZVE="></script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=nav-title><a class=nav-brand href=http://typdef.com/>Dhruv's Blog</a></div><div class=nav-links><div class=nav-link><a href=http://typdef.com/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=http://typdef.com/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/datdhruv target=_blank><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://typdef.com/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=http://typdef.com/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/datdhruv target=_blank><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Some Postgresql Examples</h1><small role=doc-subtitle>Examples that can paint a clearer picture about some powerful features and patterns of PG-SQL</small><p class=post-date>June 24, 2023</p><ul class=post-tags><li class=post-tag><a href=http://typdef.com/tags/postgresql>postgresql</a></li></ul></div><div class=post-content><p><h2 id=jsonb-to-record>jsonb to record</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> fla.offer_id, ans_data.<span style=color:#f92672>*</span>  <span style=color:#66d9ef>from</span> fla, jsonb_to_record(answer_data) <span style=color:#66d9ef>as</span> ans_data(<span style=color:#e6db74>&#34;AE46&#34;</span> text,<span style=color:#e6db74>&#34;AE3&#34;</span> text,<span style=color:#e6db74>&#34;AE16&#34;</span> text,<span style=color:#e6db74>&#34;AE45&#34;</span> date,<span style=color:#e6db74>&#34;AE47&#34;</span> date,<span style=color:#e6db74>&#34;AE55&#34;</span> text,<span style=color:#e6db74>&#34;AE60&#34;</span> text,<span style=color:#e6db74>&#34;AE61&#34;</span> text,<span style=color:#e6db74>&#34;AE73&#34;</span> date,<span style=color:#e6db74>&#34;AE74&#34;</span> date,<span style=color:#e6db74>&#34;AE62&#34;</span> text,<span style=color:#e6db74>&#34;AE27&#34;</span> text,<span style=color:#e6db74>&#34;AE42&#34;</span> text,<span style=color:#e6db74>&#34;AE58&#34;</span> text,<span style=color:#e6db74>&#34;AE25&#34;</span> text,<span style=color:#e6db74>&#34;AE54&#34;</span> text,<span style=color:#e6db74>&#34;AE44&#34;</span> text,<span style=color:#e6db74>&#34;AE17&#34;</span> text,<span style=color:#e6db74>&#34;AE53&#34;</span> text,<span style=color:#e6db74>&#34;AE59&#34;</span> text,<span style=color:#e6db74>&#34;AE19&#34;</span> text,<span style=color:#e6db74>&#34;AE56&#34;</span> text,<span style=color:#e6db74>&#34;AE21&#34;</span> text,<span style=color:#e6db74>&#34;AE57&#34;</span> text,<span style=color:#e6db74>&#34;AE33&#34;</span> text,<span style=color:#e6db74>&#34;AE32&#34;</span> text,<span style=color:#e6db74>&#34;AE41&#34;</span> date,<span style=color:#e6db74>&#34;AE31&#34;</span> date,<span style=color:#e6db74>&#34;AE65&#34;</span> text,<span style=color:#e6db74>&#34;AE66&#34;</span> text,<span style=color:#e6db74>&#34;AE67&#34;</span> text,<span style=color:#e6db74>&#34;AE72&#34;</span> text,<span style=color:#e6db74>&#34;AE52&#34;</span> text,<span style=color:#e6db74>&#34;AE38&#34;</span> text,<span style=color:#e6db74>&#34;AE69&#34;</span> text,<span style=color:#e6db74>&#34;AE70&#34;</span> text,<span style=color:#e6db74>&#34;AE68&#34;</span> text,<span style=color:#e6db74>&#34;AE71&#34;</span> text,<span style=color:#e6db74>&#34;AE39&#34;</span> text); 
</span></span></code></pre></div><h2 id=accessing-records-key-and-values>Accessing record&rsquo;s key and values</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> offer_id, rev, bf.<span style=color:#66d9ef>key</span> <span style=color:#66d9ef>as</span> business_field, bf.value <span style=color:#66d9ef>as</span> business_field_comments <span style=color:#66d9ef>from</span> <span style=color:#66d9ef>table_name</span> tn, jsonb_each_text((tn.answer_data<span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;FI5&#39;</span>)::jsonb) <span style=color:#66d9ef>as</span> bf;
</span></span></code></pre></div><h2 id=json-string-agg>JSON String agg</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Data is stored as text within a json. Data itself is of type json
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- The end output is comma separted string from json keys
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> string_agg(bf, e<span style=color:#e6db74>&#39;, &#39;</span>)  <span style=color:#66d9ef>from</span> fact_logbook_ae fla, json_object_keys((fla.answer_data<span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;AE54&#39;</span>)::json) bf <span style=color:#66d9ef>where</span> offer_id<span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SECD-20230013&#39;</span>;
</span></span></code></pre></div><h2 id=update-record-on-conflict-while-inserting>Update record on conflict while inserting</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-perl data-lang=perl><span style=display:flex><span><span style=color:#66d9ef>my</span> $STMT <span style=color:#f92672>=</span> $DBH<span style=color:#f92672>-&gt;</span>prepare(<span style=color:#e6db74>qq~insert into scd_logbook.fact_logbook_ae (offer_id,rev,answer_data,created_by_gid,last_saved_by_gid,created_ts,last_saved_ts) values(?,?,?,?,?,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP) on conflict (offer_id, rev)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		do update set answer_data=excluded.answer_data, last_saved_ts=CURRENT_TIMESTAMP, last_saved_by_gid=excluded.last_saved_by_gid~</span>) <span style=color:#f92672>or</span> report_error(<span style=color:#e6db74>&#34;Error preparing SQL:&#34;</span><span style=color:#f92672>.</span>$DBH<span style=color:#f92672>-&gt;</span>errstr());
</span></span><span style=display:flex><span>		$STMT<span style=color:#f92672>-&gt;</span>execute(<span style=color:#e6db74>&#34;$OFFER_ID&#34;</span>,$FD{REV},encode_json <span style=color:#f92672>\</span>%ANS,$FD{GID},$FD{GID}) <span style=color:#f92672>or</span> report_error(<span style=color:#e6db74>&#34;Error executing SQL:&#34;</span><span style=color:#f92672>.</span>$DBH<span style=color:#f92672>-&gt;</span>errstr()) ;
</span></span></code></pre></div><h2 id=getting-max-of-a-revision>Getting max of a revision</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> 
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>select</span> fla.offer_id, rank() over (partition <span style=color:#66d9ef>by</span> fla.offer_id <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> fla.rev <span style=color:#66d9ef>desc</span>) <span style=color:#66d9ef>as</span> rank_rev, fla.rev
</span></span><span style=display:flex><span><span style=color:#66d9ef>from</span> fla_table fla) <span style=color:#66d9ef>as</span> cd
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span> rank_rev <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><h2 id=validate-booking-using-functions>Validate Booking using Functions</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> validate_booking_date()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>TRIGGER</span> <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DECLARE</span>
</span></span><span style=display:flex><span>  max_booking_end_date DATE;
</span></span><span style=display:flex><span><span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>MAX</span>(booking_end) <span style=color:#66d9ef>INTO</span> max_booking_end_date
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span>  your_table
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WHERE</span> toolset_id  <span style=color:#f92672>=</span> <span style=color:#66d9ef>NEW</span>.toolset_id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NEW</span>.booking_start <span style=color:#f92672>&lt;=</span> max_booking_end_date <span style=color:#66d9ef>THEN</span>
</span></span><span style=display:flex><span>    RAISE <span style=color:#66d9ef>EXCEPTION</span> <span style=color:#e6db74>&#39;Booking start date must be greater than the maximum booking end date.&#39;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>END</span> <span style=color:#66d9ef>IF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>RETURN</span> <span style=color:#66d9ef>NEW</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>END</span>;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$$</span> <span style=color:#66d9ef>LANGUAGE</span> plpgsql;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Create a trigger that calls the validate_booking_date function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TRIGGER</span> check_booking_date_trigger
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>BEFORE</span> <span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>ON</span> your_table
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FOR</span> <span style=color:#66d9ef>EACH</span> <span style=color:#66d9ef>ROW</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>EXECUTE</span> <span style=color:#66d9ef>FUNCTION</span> validate_booking_date();
</span></span></code></pre></div><h2 id=control-access-when-creating-a-dashboard>Control access when creating a dashboard</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- as admin
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>user</span> app_owner <span style=color:#66d9ef>with</span> password <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>schema</span> app <span style=color:#66d9ef>authorization</span> app_owner;
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>role</span> app_readers;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- run following as schema owner
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>grant</span> <span style=color:#66d9ef>usage</span> <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>schema</span> app <span style=color:#66d9ef>to</span> app_readers;
</span></span><span style=display:flex><span><span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>privileges</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>schema</span> app <span style=color:#66d9ef>grant</span> <span style=color:#66d9ef>select</span> <span style=color:#66d9ef>on</span> tables <span style=color:#66d9ef>to</span> app_readers;
</span></span><span style=display:flex><span><span style=color:#66d9ef>grant</span> <span style=color:#66d9ef>select</span> <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>all</span> tables <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>schema</span> app <span style=color:#66d9ef>to</span> app_readers;
</span></span></code></pre></div><h2 id=get-column-names-of-a-table>Get column names of a table</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> information_schema.columns
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> table_schema <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;your_schema&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>AND</span> <span style=color:#66d9ef>table_name</span>   <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;your_table&#39;</span>;
</span></span></code></pre></div><h2 id=update-inline>Update inline</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Update the consumer names
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>update</span> evaluation.lkp_consumer <span style=color:#66d9ef>set</span> consumer_name <span style=color:#f92672>=</span> t.new_consumer <span style=color:#66d9ef>from</span> 
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>values</span> 
</span></span><span style=display:flex><span>    (<span style=color:#e6db74>&#39;SE GS C ME&#39;</span>, <span style=color:#e6db74>&#39;SE GS C RSO ME&#39;</span>),
</span></span><span style=display:flex><span>    (<span style=color:#e6db74>&#39;SE GS C CD ME&#39;</span>, <span style=color:#e6db74>&#39;SE GS C RSO CD ME&#39;</span>),
</span></span><span style=display:flex><span>    (<span style=color:#e6db74>&#39;SE GS D ME&#39;</span>, <span style=color:#e6db74>&#39;SE GS D RSO ME&#39;</span>),
</span></span><span style=display:flex><span>    (<span style=color:#e6db74>&#39;SE GT ME&#39;</span>, <span style=color:#e6db74>&#39;SE GT RSO ME&#39;</span>),
</span></span><span style=display:flex><span>    (<span style=color:#e6db74>&#39;SE GS C REU&#39;</span>, <span style=color:#e6db74>&#39;SE GS C RSO EU&amp;AF&#39;</span>)
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>as</span> t(prev_consumer, new_consumer) <span style=color:#66d9ef>where</span> t.prev_consumer <span style=color:#f92672>=</span> consumer_name;
</span></span></code></pre></div><h2 id=random-sampling>Random sampling</h2><p>Scenario :
Let&rsquo;s say you are working as SQL Developer and you are asked to provide some sample data from a table. You need to provide 10 rows or 100 rows but they should be selected random from table.</p><p>Solution :
You can use <code>random()</code> function with Limit to get RANDOM ROWS from table. By using Limit you will restrict the number of rows you want to return.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> YourTableName <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> random() <span style=color:#66d9ef>limit</span> <span style=color:#66d9ef>count</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Example
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> customer <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> random <span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>10</span>;
</span></span></code></pre></div></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="topFunction()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function topFunction(){smoothScrollToTop()}function smoothScrollToTop(){const e=()=>{const t=document.documentElement.scrollTop||document.body.scrollTop;t>0&&(window.requestAnimationFrame(e),window.scrollTo(0,t-t/8))};e()}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><a href=#jsonb-to-record>jsonb to record</a></li><li><a href=#accessing-records-key-and-values>Accessing record&rsquo;s key and values</a></li><li><a href=#json-string-agg>JSON String agg</a></li><li><a href=#update-record-on-conflict-while-inserting>Update record on conflict while inserting</a></li><li><a href=#getting-max-of-a-revision>Getting max of a revision</a></li><li><a href=#validate-booking-using-functions>Validate Booking using Functions</a></li><li><a href=#control-access-when-creating-a-dashboard>Control access when creating a dashboard</a></li><li><a href=#get-column-names-of-a-table>Get column names of a table</a></li><li><a href=#update-inline>Update inline</a></li><li><a href=#random-sampling>Random sampling</a></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2024 datDhruv</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>